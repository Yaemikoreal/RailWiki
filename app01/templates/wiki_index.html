{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RailWiki - å´©åï¼šæ˜Ÿç©¹é“é“ç™¾ç§‘</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', sans-serif; }
        body { min-height: 100vh; background: linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)), url("{% static 'images/bg1.png' %}") center/cover fixed; }
        .main-container { display: flex; flex-direction: column; align-items: center; padding: 2vh 5%; }
        .logo-section { text-align: center; margin: 2vh 0; animation: fadeInDown 1s ease; }
        .logo { width: 80px; filter: drop-shadow(0 0 10px rgba(113, 76, 255, 0.8)); }
        .title { color: #fff; font-size: 2.5rem; text-shadow: 0 0 20px #714CFF; margin-top: 10px; }
        .nav-buttons { display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap; justify-content: center; }
        .nav-button { background: rgba(17, 23, 41, 0.8); border: 2px solid #4A5568; padding: 15px 25px; border-radius: 10px; color: #CBD5E0; font-size: 1.2rem; min-width: 180px; transition: all 0.3s ease; }
        .filters { width: 100%; max-width: 1200px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0; backdrop-filter: blur(5px); }
        .filter-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .filter-item { display: flex; align-items: center; gap: 5px; color: black; }
        select { background: rgba(0,0,0,0.5); color: white; border: 1px solid #714CFF; padding: 8px 15px; border-radius: 5px; }
        .character-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 15px; width: 100%; max-width: 1600px; padding: 20px 0; }
        .character-card { background: rgba(0, 0, 0, 0.25); border-radius: 8px; overflow: hidden; transition: transform 0.3s ease; text-align: center; width: 140px; height: 310px;}
        .character-card:hover {transform: translateY(-5px);}
        .character-img { width: 100%; height: 234px; object-fit: cover; }
        .character-name { color: black; padding: 8px; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #714CFF; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        .pagination-controls { width: 100%; text-align: center; padding: 20px 0; color: white; }
        .pagination-controls button { background: rgba(113, 76, 255, 0.3); border: 1px solid #714CFF; color: white; padding: 8px 16px; margin: 0 5px; border-radius: 4px; cursor: pointer; }
        .character-meta { padding: 5px; display: flex; justify-content: space-between; font-size: 0.8rem; }
        .element { padding: 2px 5px; border-radius: 3px; }
        .element.é‡å­ { background: #9932CC; } .element.ç« { background: #e74c3c; }.element.å†° { background: #7FDFFC; }
        .element.è™šæ•° { background: #FFD700; } .element.é›· { background: #D8BFD8; }.element.é£ { background: #00FF00; }
        .element.ç‰©ç† { background: #C0C0C0; }
        .rarity-5 { color: gold; } .rarity-4 { color: silver; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 1200px) { .character-grid { grid-template-columns: repeat(5, 1fr); } }
        @media (max-width: 768px) { .nav-buttons { flex-direction: column; width: 100%; } .nav-button { width: 100%; } .character-grid { grid-template-columns: repeat(3, 1fr); } }
        /* æ–°å¢é”™è¯¯æç¤ºæ ·å¼ */
        .error-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #e74c3c; color: white; padding: 12px 24px; border-radius: 4px; z-index: 1000; animation: fadeInOut 2.5s; }
        @keyframes fadeInOut { 0% { opacity: 0; } 15% { opacity: 1; } 85% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body>
    <main class="main-container">
        <!-- LogoåŒºåŸŸ -->
        <div class="logo-section">
            <img src="{% static 'images/logo.jpg' %}" alt="RailWiki Logo" class="logo">
            <h1 class="title">RailWiki</h1>
        </div>

        <!-- å¯¼èˆªæŒ‰é’®ï¼ˆå·²ç§»é™¤ç‚¹å‡»äº‹ä»¶ï¼‰ -->
        <div class="nav-buttons">
            <button class="nav-button">ğŸŒŸ è§’è‰²å›¾é‰´</button>
            <button class="nav-button">ğŸ“– æ”»ç•¥ç™¾ç§‘</button>
            <button class="nav-button">âš’ï¸ å…»æˆæŒ‡å—</button>
            <button class="nav-button">ğŸ›¡ï¸ æ•Œäººèµ„æ–™</button>
        </div>

        <!-- ç­›é€‰å™¨ -->
        <div class="filters">
            <div class="filter-group">
                <div class="filter-item">
                    <label>å±æ€§ï¼š</label>
                    <select id="element-filter">
                        <option value="">å…¨éƒ¨</option>
                        <option>ç«</option>
                        <option>å†°</option>
                        <option>é‡å­</option>
                        <option>è™šæ•°</option>
                        <option>é›·</option>
                        <option>é£</option>
                        <option>ç‰©ç†</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>å‘½é€”ï¼š</label>
                    <select id="path-filter">
                        <option value="">å…¨éƒ¨</option>
                        <option>æ¯ç­</option>
                        <option>å·¡çŒ</option>
                        <option>ä¸°é¥¶</option>
                        <option>è™šæ— </option>
                        <option>æ™ºè¯†</option>
                        <option>åŒè°</option>
                        <option>å­˜æŠ¤</option>
                        <option>è®°å¿†</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>ç¨€æœ‰åº¦ï¼š</label>
                    <select id="rarity-filter">
                        <option value="">å…¨éƒ¨</option>
                        <option>5æ˜Ÿ</option>
                        <option>4æ˜Ÿ</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- è§’è‰²å±•ç¤ºåŒº -->
        <div class="character-grid" id="character-container"></div>

        <!-- åŠ è½½çŠ¶æ€ & åˆ†é¡µ -->
        <div class="pagination-controls">
            <div id="loading" style="display: none;">
                <div class="loader"></div>
                åŠ è½½ä¸­...
            </div>
            <div id="pagination"></div>
        </div>
    </main>

    <!-- é”™è¯¯æç¤ºå®¹å™¨ -->
    <div id="errorToast" class="error-toast" style="display: none;"></div>

    <script>
        // å…¨å±€é…ç½®
        let currentPage = 1;        // å½“å‰é¡µç 
        const pageSize = 10;        // æ¯é¡µæ˜¾ç¤ºæ•°é‡
        let filterTimeout;          // é˜²æŠ–å®šæ—¶å™¨

        // ä¸»åŠ è½½å‡½æ•°ï¼šè·å–å¹¶æ˜¾ç¤ºè§’è‰²æ•°æ®
        async function loadCharacters() {
            try {
                showLoading(true);  // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»

                //  æ­¥éª¤1ï¼šæ„å»ºå®‰å…¨è¯·æ±‚å‚æ•°
                const params = new URLSearchParams({
                    page: currentPage,
                    page_size: pageSize
                });

                // è·å–ç­›é€‰æ¡ä»¶ï¼ˆå…³é”®ä¿®æ­£ï¼‰
                const elements = getSelectedValues('element-filter');
                const paths = getSelectedValues('path-filter');
                const rarities = getSelectedValues('rarity-filter');

                // æ­£ç¡®æ·»åŠ éç©ºå‚æ•°
                if (elements.length > 0) params.append('elements', elements.join(','));
                if (paths.length > 0) params.append('paths', paths.join(','));
                if (rarities.length > 0) params.append('rarities', rarities.join(','));

                console.log('è¯·æ±‚å‚æ•°ï¼š', params.toString());  // è°ƒè¯•æ—¥å¿—

                //  æ·»åŠ è¯·æ±‚è¶…æ—¶æ§åˆ¶ï¼ˆ10ç§’ï¼‰
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                //  å‘é€APIè¯·æ±‚
                const response = await fetch(`/api/characters/paginationquery/?${params}`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);  // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨

                // å¤„ç†HTTPé”™è¯¯çŠ¶æ€
                if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥ï¼š${response.status} ${response.statusText}`);

                // è§£æå“åº”æ•°æ®
                const data = await response.json();
                console.log('æ”¶åˆ°æ•°æ®ï¼š', data);  // è°ƒè¯•æ—¥å¿—

                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                updateCharacterDisplay(data);
                updatePagination(data.total);

            } catch (error) {
                // é”™è¯¯å¤„ç†
                console.error('åŠ è½½å¤±è´¥ï¼š', error);
                showToast(`åŠ è½½å¤±è´¥ï¼š${error.message}`);

                // ç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•ï¼ˆæ’é™¤ç”¨æˆ·å–æ¶ˆçš„æƒ…å†µï¼‰
                if (error.name !== 'AbortError') {
                    setTimeout(() => loadCharacters(), 2000);  // 2ç§’åé‡è¯•
                }
            } finally {
                showLoading(false);  // éšè—åŠ è½½åŠ¨ç”»
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–é€‰ä¸­çš„ç­›é€‰å€¼
        function getSelectedValues(selectId) {
            const select = document.getElementById(selectId);
            return Array.from(select.options)
                .filter(option => option.selected && option.value !== '')  // æ’é™¤ç©ºå€¼
                .map(option => option.value);
        }

        // æ›´æ–°è§’è‰²æ˜¾ç¤º
        function updateCharacterDisplay(data) {
            const container = document.getElementById('character-container');
            container.innerHTML = data.characters.map(char => `
                <div class="character-card" data-id="${char.id}" onclick="showCharacterDetail(${char.id})">
                    <img src="${char.character_image_3}"
                         alt="${char.name}"
                         class="character-img"
                         onerror="this.src='{% static 'images/default.png' %}'"> <!-- å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç† -->
                    <div class="character-name">${char.name}</div>
                    <div class="character-meta">
                        <span class="element ${char.element}">${char.element}</span>
                        <span class="rarity-${char.rarity}">${'â˜…'.repeat(char.rarity)}</span>
                    </div>
                </div>
            `).join('');
        }

        // æ–°å¢ç‚¹å‡»å¡ç‰‡è·³è½¬å‡½æ•°
        function showCharacterDetail(characterId) {
            // æ–¹å¼1ï¼šç›´æ¥è·³è½¬æºå¸¦ID
            window.location.href = `/api/characters/character_detail/?id=${characterId}`;

            {#// æ–¹å¼2ï¼šå­˜å‚¨åˆ°æœ¬åœ°åè·³è½¬ï¼ˆæ¨èï¼‰#}
            {#localStorage.setItem('selectedCharacterId', characterId);#}
            {#window.location.href = '`/api/characters/ character_detail/`';#}
        }

        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination(total) {
            const totalPages = Math.ceil(total / pageSize);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = `
                <button ${currentPage === 1 ? 'disabled' : ''}
                        onclick="changePage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>
                <span>${currentPage} / ${totalPages}</span>
                <button ${currentPage >= totalPages ? 'disabled' : ''}
                        onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>
            `;
        }

        // åˆ†é¡µæ“ä½œ
        function changePage(newPage) {
            currentPage = Math.max(1, newPage);  // é¡µç ä¸èƒ½å°äº1
            loadCharacters();
            window.scrollTo({ top: 0, behavior: 'smooth' });  // æ»šåŠ¨åˆ°é¡¶éƒ¨
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showToast(message) {
            const toast = document.getElementById('errorToast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2500);
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬ï¼ˆå¸¦é˜²æŠ–å¤„ç†ï¼‰
        document.querySelectorAll('.filter-item select').forEach(select => {
            select.addEventListener('change', () => {
                clearTimeout(filterTimeout);  // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                filterTimeout = setTimeout(() => {
                    currentPage = 1;  // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                    loadCharacters();
                }, 300);  // 300æ¯«ç§’é˜²æŠ–å»¶è¿Ÿ
            });
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', loadCharacters);

        // ç§»é™¤æ‰€æœ‰æ—§ç‰ˆè·³è½¬é€»è¾‘ï¼ˆå…³é”®ä¿®å¤ï¼‰
        document.querySelectorAll('.nav-button').forEach(button => {
            button.onclick = null;  // æ¸…é™¤ç‚¹å‡»äº‹ä»¶
        });
    </script>
</body>
</html>